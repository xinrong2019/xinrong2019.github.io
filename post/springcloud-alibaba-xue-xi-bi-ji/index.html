<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta HTTP-EQUIV="pragma" CONTENT="no-cache"> 
<meta HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate"> 
<meta HTTP-EQUIV="expires" CONTENT="0"> 
<title>SpringCloud Alibaba学习笔记 | Eucaly</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css">

<link rel="stylesheet" href="https://xinrong2019.github.io//styles/main.css">
<script type="text/javascript">
function getCSS()
{
        datetoday = new Date();
        timenow=datetoday.getTime();
        datetoday.setTime(timenow);
        thehour = datetoday.getHours();

            display = "https://xinrong2019.github.io//media/css/night.css";

            display = "https://xinrong2019.github.io//media/css/night.css";   
      
            display = "https://xinrong2019.github.io//media/css/day.css";

            display = "https://xinrong2019.github.io//media/css/day.css";
      

var css = '<';
        css+='link rel="stylesheet" href='+display+' \/';
        css+='>';
        document.write(css);
}
</script>
<link href="https://fonts.googleapis.com/css?family=Dancing+Script|Noto+Sans+SC:300|Montserrat&display=swap" rel="stylesheet">
<link href="https://at.alicdn.com/t/font_1306644_jwtuc2zzbrd.css" rel="stylesheet" />
<link href="https://at.alicdn.com/t/font_1651848_tf0hnpbyjfj.css" rel="stylesheet" />
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<script type='text/javascript' src='https://xinrong2019.github.io//media/scripts/script.js'></script>
<link href="https://cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet" />
  <script src="https://cdn.bootcss.com/wow/1.1.2/wow.min.js"></script>
  <script src="https://cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <script>wow=new WOW({boxClass:'wow',animateClass:'animated',offset:0,mobile:true,live:true});wow.init();</script>

<script type="text/javascript">
window.onload=getCSS();
</script>


</head>

<body class="post-template-default single single-post postid-70 single-format-standard">
	<div id="wrapper">
				<header id="header" class="site-header" >
			<div class="site-branding">
				<h1 class="site-title">
					<div class="post-title-name">
						<a href="https://xinrong2019.github.io/" rel="home">SpringCloud Alibaba学习笔记</a>
					</div>
				</h1>
				<h2 class="site-description">Time waits for no one.</h2>
			</div>
			<nav id="nav-wrapper">
				<div class="container">
					<div class="nav-toggle">
						<div class="bars">
							<div class="bar"></div>
							<div class="bar"></div>
							<div class="bar"></div>
						</div>
					</div>
					<div class="clear"></div>
					<ul id="" class="dove">
						

						<li>

							<a href="/"> 首页</a></li>

						

						<li>

							<a href="/archives"> 归档</a></li>

						

						<li>

							<a href="/tags"> 标签</a></li>

						

						<li>

							<a href="/friends"> 友链</a></li>

						

						<li>

							<a href="/post/mysql"> MySQL</a></li>

						

						<li>

							<a href="/post/dubbo"> Dubbo</a></li>

						

						<li>

							<a href="/post/mq"> MQ</a></li>

						

						<li>

							<a href="/post/spring"> Spring</a></li>

						

						<li>

							<a href="/post/about"> 关于</a></li>

						

					</ul>
					</li>

					</ul>
				</div>
			</nav>

			<div class="jingge">
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
				
			</div>
			<form id="gridea-search-form" data-update="1588472233599" action="/search/index.html">
				<div class="search-box">
					<input class="search-txt" name="q" placeholder="Type to search" />
					<a class="search-btn">
						<i class="iconfont icon-search1" action="/search/index.html"></i>
					</a>
				</div>
			</form>
		</header>
		<div id="content" class="container">
			<div class="row">
				<div class="col-md-8 site-main">
					<article id="post-70"
						class="post-70 post type-post status-publish format-standard hentry category-5 tag-10 tag-9 tag-11">
						<div class="entry-content">
							<div class="entry-meta">
								<div class="entry-info">
									<time>
										2020-04-04
									</time>
									<span>
										42 min read
									</span>
								</div>
							</div>
							<div class="wow slideInLeft entry-summary song">
								<h1 id="springcloud-alibaba学习笔记">SpringCloud Alibaba学习笔记</h1>
<h2 id="目录">目录</h2>
<p>[TOC]</p>
<h2 id="导学">导学</h2>
<h3 id="为什么学">为什么学</h3>
<ul>
<li>组件性能更强</li>
<li>良好的可视化界面</li>
<li>搭建简单，学习曲线低</li>
<li>文档丰富并且是中文</li>
</ul>
<h3 id="学习目标">学习目标</h3>
<ul>
<li>Spring Cloud Alibaba核心组件的用法及实现原理</li>
<li>Spring Cloud Alibaba结合微信小程序从&quot;0&quot;学习真正开发中的使用</li>
<li>实际工作中如何避免踩坑，正确的思考问题方式</li>
<li>Spring Cloud Alibaba的进阶：代码的优化和改善，微服务监控</li>
</ul>
<h3 id="进阶目标">进阶目标</h3>
<ul>
<li>如何提升团队的代码质量
<ul>
<li>编码技巧</li>
<li>心得总结</li>
</ul>
</li>
<li>如何改善代码结构设计
<ul>
<li>借助监控工具</li>
<li>定位问题</li>
<li>解决问题</li>
</ul>
</li>
</ul>
<h3 id="思路">思路</h3>
<p>分析并拆解微服务-&gt;编写代码-&gt;分析现有架构问题-&gt;引入微服务组件-&gt;优化重构-&gt;总结完善</p>
<h3 id="spring-cloud-alibaba的重要组件">Spring Cloud Alibaba的重要组件</h3>
<ul>
<li>服务发现Nacos
<ul>
<li>服务发现原理剖析</li>
<li>Nacos Server/Client</li>
<li>高可用Nacos搭建</li>
</ul>
</li>
<li>实现负载均衡Ribbon
<ul>
<li>负载均衡的常见模式</li>
<li>RestTemplate整合Ribbon</li>
<li>Ribbon配置自定义</li>
<li>如何扩展Ribbon</li>
</ul>
</li>
<li>声明式HTTP客户端-Feign
<ul>
<li>如何使用Feign</li>
<li>Feign配置自定义</li>
<li>如何扩展Feign</li>
</ul>
</li>
<li>服务容错Sentinel
<ul>
<li>服务容错原理</li>
<li>Sentinel</li>
<li>Sentinel DashBoard</li>
<li>Sentinel核心原理分析</li>
</ul>
</li>
<li>消息驱动RocketMq
<ul>
<li>Spring Cloud Stream</li>
<li>实现异步消息推送与消费</li>
</ul>
</li>
<li>API网关Gateway
<ul>
<li>整合Gateway</li>
<li>三大核心</li>
<li>聚合微服务请求</li>
</ul>
</li>
<li>用户认证与授权
<ul>
<li>认证授权的常见方案</li>
<li>改造Gateway</li>
<li>扩展Feign</li>
</ul>
</li>
<li>配置管理Nacos
<ul>
<li>配置如何管理</li>
<li>配置动态刷新</li>
<li>配置管理的最佳实践</li>
</ul>
</li>
<li>调用链监控Sleuth
<ul>
<li>调用链监控原理剖析</li>
<li>Sleuth使用</li>
<li>Zipkin使用</li>
</ul>
</li>
</ul>
<h2 id="环境搭建">环境搭建</h2>
<ul>
<li>JDK8</li>
<li>MySQL</li>
<li>Maven的安装与配置</li>
<li>IDEA</li>
</ul>
<h2 id="spring-boot必知必会">Spring Boot必知必会</h2>
<h3 id="spring-boot特性">Spring Boot特性</h3>
<ul>
<li>无需部署WAR文件</li>
<li>提供stater简化配置</li>
<li>尽可能自动配置Spring以及第三方库</li>
<li>提供&quot;生产就绪&quot;功能，例如指标、健康检查、外部配置等</li>
<li>无代码生成&amp;无XML</li>
</ul>
<h3 id="编写第一个spring-boot应用">编写第一个Spring Boot应用</h3>
<h3 id="spring-boot应用组成分析">Spring Boot应用组成分析</h3>
<ul>
<li>依赖：pom.xml</li>
<li>启动类：注解</li>
<li>配置：application.properties</li>
<li>static目录：静态文件</li>
<li>templates目录：模板文件</li>
</ul>
<h3 id="spring-boot开发三板斧">Spring Boot开发三板斧</h3>
<ul>
<li>加依赖</li>
<li>写注解</li>
<li>写配置</li>
</ul>
<h3 id="spring-boot-actuator">Spring Boot Actuator</h3>
<p>监控工具</p>
<h4 id="actuator">/actuator</h4>
<p>入口</p>
<h4 id="health">/health</h4>
<p>健康检查</p>
<p>显示详情配置</p>
<pre><code class="language-properties">management.endpoint.health.show-details=always
# 显示所有监控端点
management.endpoints.web.exposure.include=*

# 描述信息（自定义键值对）
info.app-name=spring-boot-demo
info.author=kim
info.email=xxx@163.com
</code></pre>
<h3 id="spring-boot配置管理">Spring Boot配置管理</h3>
<p>支持的配置格式</p>
<pre><code class="language-yaml">management:
  endpoint:
    health:
      show-details: always
  endpoints:
    web:
      exposure:
        include: '*'

  # 描述信息
info:
  app-name: spring-boot-demo
  author: kim
  email: xxx@163.com
</code></pre>
<p>注意：值是*，yml写法需要加引号</p>
<ul>
<li>yml是使用趋势</li>
<li>yml在有的配置中可以表达顺序，properties不行</li>
</ul>
<p>17种配置方式</p>
<figure data-type="image" tabindex="1"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic/2ncu17_2020_04_04_12_37_13.png" alt="" loading="lazy"></figure>
<p>实际项目种经常用到的配置管理方式：</p>
<ul>
<li>配置文件</li>
<li>环境变量</li>
<li>外部配置文件</li>
<li>命令行参数</li>
</ul>
<h4 id="环境变量方式配置管理">环境变量方式配置管理</h4>
<p>application.yml</p>
<pre><code class="language-yaml">management:
  endpoint:
    health:
      show-details: ${SOME_ENV}
  endpoints:
    web:
      exposure:
        include: '*'

  # 描述信息
info:
  app-name: spring-boot-demo
  author: kim
  email: xxx@163.com
</code></pre>
<p>设置环境变量<code>SOME_ENV</code></p>
<figure data-type="image" tabindex="2"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic/E5UBsc_2020_04_04_12_45_05.png" alt="" loading="lazy"></figure>
<h4 id="环境变量方式配置管理java-jar方式">环境变量方式配置管理（java -jar方式）</h4>
<p><code>mvn clean install -DskipTests</code></p>
<p><code>java -jar spring-boot-demo-0.0.1-SNAPSHOT.jar --SOME_ENV=always</code></p>
<h4 id="外部配置文件方式配置管理">外部配置文件方式配置管理</h4>
<p>将打的jar包和配置文件放在同一目录，会优先读取该配置文件内配置</p>
<h4 id="命令行参数方式配置管理">命令行参数方式配置管理</h4>
<p><code>java -jar spring-boot-demo-0.0.1-SNAPSHOT.jar --server.port=8081</code></p>
<h4 id="最佳实践">最佳实践</h4>
<p>KISS，规避掉优先级，没人会记住17中配置姿势的优先级。</p>
<h3 id="profile">Profile</h3>
<pre><code class="language-yaml"># 所有环境下公用的配置属性
management:
  endpoint:
    health:
      show-details: ${SOME_ENV}
  endpoints:
    web:
      exposure:
        include: '*'

  # 描述信息
info:
  app-name: spring-boot-demo
  author: kim
  email: xxx@163.com

# 连字符
---
# profile=x的专用属性，也就是说某个环境下的专用属性
# 开发环境
spring:
  profiles: dev

---
# profile=y的专用属性，也就是说某个环境下的专用属性
# 生产环境
spring:
  profiles: prod
server:
  tomcat:
    max-threads: 300
    max-connections: 1000
</code></pre>
<p>IDEA启动配置</p>
<figure data-type="image" tabindex="3"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic/0cmidO_2020_04_04_13_00_38.png" alt="" loading="lazy"></figure>
<p>访问http://localhost:8080/actuator/configprops通过actuator端口查看</p>
<figure data-type="image" tabindex="4"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic/L6Qjuf_2020_04_04_13_03_39.png" alt="" loading="lazy"></figure>
<p>默认使用default，可以通过添加配置设置默认profile</p>
<pre><code class="language-yaml">spring:
  profiles:
    active: dev
</code></pre>
<h4 id="最佳实践-2">最佳实践</h4>
<p>KISS，不要使用优先级，规划好公用和专用配置</p>
<h2 id="微服务拆分与编写">微服务拆分与编写</h2>
<ul>
<li>单体架构vs微服务架构
<ul>
<li>单体架构是什么</li>
<li>微服务是什么</li>
<li>微服务特性</li>
<li>微服务全景架构图</li>
<li>微服务优缺点</li>
<li>微服务适用场景</li>
</ul>
</li>
<li>业务分析与建模
<ul>
<li>项目功能演示与分析</li>
<li>微服务拆分</li>
<li>项目架构图</li>
<li>数据库设计</li>
<li>API文档</li>
</ul>
</li>
<li>编写微服务
<ul>
<li>创建小程序</li>
<li>创建项目</li>
<li>编写用户微服务</li>
<li>编写内容微服务</li>
</ul>
</li>
</ul>
<h3 id="单体架构">单体架构</h3>
<figure data-type="image" tabindex="5"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic/euh6g8_2020_04_04_13_11_38.png" alt="" loading="lazy"></figure>
<p>优点：</p>
<ul>
<li>架构简单</li>
<li>开发、测试、部署方便</li>
</ul>
<p>缺点：</p>
<ul>
<li>复杂性高</li>
<li>部署慢，频率低</li>
<li>扩展能力受限（比如用户模块是CPU密集的，只能通过买更好的CPU的机器，比如内容模块是IO密集的，只能通过购买更多内存）</li>
<li>阻碍技术创新（SpringMVC-&gt;Spring Web Flux，改动大）</li>
</ul>
<p>不适合庞大复杂的系统</p>
<h3 id="微服务">微服务</h3>
<p>拆分后的小型服务</p>
<h4 id="微服务的特性">微服务的特性</h4>
<ul>
<li>每个微服务可独立运行在自己的进程里；（每个服务一个Tomcat）</li>
<li>一系列独立运行的微服务共同构建起整个系统</li>
<li>每个服务为独立的业务开发，一个微服务只关注某个特定的功能，例如订单管理、用户管理</li>
<li>可以使用不同的语言与数据存储技术（契合项目情况和团队实力）</li>
<li>微服务之间通过轻量的通信机制进行通信，例如通过Rest API进行调用；（通信协议轻量、跨平台）</li>
<li>全自动的部署机制</li>
</ul>
<h4 id="微服务全景架构图">微服务全景架构图</h4>
<figure data-type="image" tabindex="6"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic/9qjnWH_2020_04_04_13_24_06.png" alt="" loading="lazy"></figure>
<h4 id="优点">优点</h4>
<ul>
<li>单个服务更易于开发、维护</li>
<li>单个微服务启动较快</li>
<li>局部修改容易部署</li>
<li>技术栈不受限</li>
</ul>
<h4 id="缺点">缺点</h4>
<ul>
<li>运维要求高</li>
<li>分布式固有的复杂性</li>
<li>重复劳动（不同语言调用相同功能时）</li>
</ul>
<h4 id="适用场景">适用场景</h4>
<ul>
<li>大型、复杂的项目</li>
<li>有快速迭代的需求</li>
<li>访问压力大（微服务去中心化，把业务和数据都拆分了，可以应对访问压力）</li>
</ul>
<h4 id="不适用微服务的场景">不适用微服务的场景</h4>
<ul>
<li>业务稳定</li>
<li>迭代周期长</li>
</ul>
<h3 id="项目演示">项目演示</h3>
<figure data-type="image" tabindex="7"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic/J5duZx_2020_04_04_13_34_50.png" alt="" loading="lazy"></figure>
<h3 id="微服务拆分">微服务拆分</h3>
<ul>
<li>业界流行的拆分方法论</li>
<li>个人心得</li>
<li>合理粒度</li>
<li>小程序的拆分</li>
</ul>
<h4 id="方法论">方法论</h4>
<ul>
<li>
<p>领域驱动设计（Domain Driven Design）(概念太多，学习曲线高)</p>
</li>
<li>
<p>面向对象（by name./by verb）（通过名词（状态），动词（行为）拆分）</p>
</li>
</ul>
<h4 id="个人心得">个人心得</h4>
<h5 id="职责划分">职责划分</h5>
<p>规划好微服务的边界。比如订单微服务只负责订单功能。</p>
<h5 id="通用性划分">通用性划分</h5>
<p>把一些通用功能做成微服务。比如消息中心和用户中心。</p>
<h4 id="合理的粒度">合理的粒度</h4>
<ul>
<li>良好的满足业务（这是前提）</li>
<li>幸福感（你的团队没有人认为微服务太大，难以维护，同时部署也非常高效，不会每次发布都发布N多微服务）</li>
<li>增量迭代</li>
<li>持续进化</li>
</ul>
<h4 id="小程序的拆分">小程序的拆分</h4>
<p>以面向对象方式拆分</p>
<figure data-type="image" tabindex="8"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/XeHfxG.png" alt="" loading="lazy"></figure>
<p>用户中心按照通用性划分，内容中心按照职责划分。</p>
<p>项目初期不建议拆分太细，后期如果发现某个微服务过分庞大再细分。</p>
<h4 id="项目架构图">项目架构图</h4>
<figure data-type="image" tabindex="9"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/uHGDQ8.png" alt="" loading="lazy"></figure>
<h4 id="数据库设计">数据库设计</h4>
<h5 id="数据建模">数据建模</h5>
<h5 id="建表">建表</h5>
<p><strong>user-center-create-table.sql</strong></p>
<pre><code class="language-sql">USE `user_center`;

-- -----------------------------------------------------
-- Table `user`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `user` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT 'Id',
  `wx_id` VARCHAR(64) NOT NULL DEFAULT '' COMMENT '微信id',
  `wx_nickname` VARCHAR(64) NOT NULL DEFAULT '' COMMENT '微信昵称',
  `roles` VARCHAR(100) NOT NULL DEFAULT '' COMMENT '角色',
  `avatar_url` VARCHAR(255) NOT NULL DEFAULT '' COMMENT '头像地址',
  `create_time` DATETIME NOT NULL COMMENT '创建时间',
  `update_time` DATETIME NOT NULL COMMENT '修改时间',
  `bonus` INT NOT NULL DEFAULT 300 COMMENT '积分',
  PRIMARY KEY (`id`))
COMMENT = '分享';


-- -----------------------------------------------------
-- Table `bonus_event_log`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `bonus_event_log` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT 'Id',
  `user_id` INT NULL COMMENT 'user.id',
  `value` INT NULL COMMENT '积分操作值',
  `event` VARCHAR(20) NULL COMMENT '发生的事件',
  `create_time` DATETIME NULL COMMENT '创建时间',
  `description` VARCHAR(100) NULL COMMENT '描述',
  PRIMARY KEY (`id`),
  INDEX `fk_bonus_event_log_user1_idx` (`user_id` ASC) )
ENGINE = InnoDB
COMMENT = '积分变更记录表';
</code></pre>
<p><strong>content-center-create-table.sql</strong></p>
<pre><code class="language-sql">USE `content_center`;

-- -----------------------------------------------------
-- Table `share`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `share` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT 'id',
  `user_id` INT NOT NULL DEFAULT 0 COMMENT '发布人id',
  `title` VARCHAR(80) NOT NULL DEFAULT '' COMMENT '标题',
  `create_time` DATETIME NOT NULL COMMENT '创建时间',
  `update_time` DATETIME NOT NULL COMMENT '修改时间',
  `is_original` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否原创 0:否 1:是',
  `author` VARCHAR(45) NOT NULL DEFAULT '' COMMENT '作者',
  `cover` VARCHAR(256) NOT NULL DEFAULT '' COMMENT '封面',
  `summary` VARCHAR(256) NOT NULL DEFAULT '' COMMENT '概要信息',
  `price` INT NOT NULL DEFAULT 0 COMMENT '价格（需要的积分）',
  `download_url` VARCHAR(256) NOT NULL DEFAULT '' COMMENT '下载地址',
  `buy_count` INT NOT NULL DEFAULT 0 COMMENT '下载数 ',
  `show_flag` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否显示 0:否 1:是',
  `audit_status` VARCHAR(10) NOT NULL DEFAULT 0 COMMENT '审核状态 NOT_YET: 待审核 PASSED:审核通过 REJECTED:审核不通过',
  `reason` VARCHAR(200) NOT NULL DEFAULT '' COMMENT '审核不通过原因',
  PRIMARY KEY (`id`))
ENGINE = InnoDB
COMMENT = '分享表';


-- -----------------------------------------------------
-- Table `mid_user_share`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `mid_user_share` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `share_id` INT NOT NULL COMMENT 'share.id',
  `user_id` INT NOT NULL COMMENT 'user.id',
  PRIMARY KEY (`id`),
  INDEX `fk_mid_user_share_share1_idx` (`share_id` ASC) ,
  INDEX `fk_mid_user_share_user1_idx` (`user_id` ASC) )
ENGINE = InnoDB
COMMENT = '用户-分享中间表【描述用户购买的分享】';


-- -----------------------------------------------------
-- Table `notice`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `notice` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT 'id',
  `content` VARCHAR(255) NOT NULL DEFAULT '' COMMENT '内容',
  `show_flag` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否显示 0:否 1:是',
  `create_time` DATETIME NOT NULL COMMENT '创建时间',
  PRIMARY KEY (`id`));
</code></pre>
<h4 id="api-文档">API 文档</h4>
<p>课程文档主要分四类：</p>
<ol>
<li>API文档：https://t.itmuch.com/doc.html</li>
<li>课程配套代码：https://git.imooc.com/coding-358/</li>
<li>课程相关资源（例如检表语句、数据模型、课上用到的软件等）：https://git.imooc.com/coding-358/resource</li>
<li>课上用到的一些课外读物（慕课网手记）：http://www.imooc.com/t/1863086</li>
</ol>
<h4 id="如何创建小程序">如何创建小程序</h4>
<p>注册账号：https://mp.weixin.qq.com</p>
<p>按照提示填写信息</p>
<h4 id="前端代码如何使用">前端代码如何使用</h4>
<h4 id="创建项目">创建项目</h4>
<h5 id="技术选型">技术选型</h5>
<ul>
<li>Spring Boot</li>
<li>Spring MVC</li>
<li>Mybatis+通用Mapper</li>
<li>Spring Cloud Alibaba（分布式）</li>
</ul>
<h5 id="工程结构规划">工程结构规划</h5>
<figure data-type="image" tabindex="10"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/DIgVS4.png" alt="" loading="lazy"></figure>
<h5 id="创建项目整合框架">创建项目，整合框架</h5>
<p>pom.xml</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
	xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
	&lt;parent&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
		&lt;version&gt;2.1.13.RELEASE&lt;/version&gt;
		&lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
	&lt;/parent&gt;
	&lt;groupId&gt;com.itmuch&lt;/groupId&gt;
	&lt;artifactId&gt;user-center&lt;/artifactId&gt;
	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
	&lt;name&gt;user-center&lt;/name&gt;
	&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;

	&lt;properties&gt;
		&lt;java.version&gt;1.8&lt;/java.version&gt;
	&lt;/properties&gt;

	&lt;dependencies&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
		&lt;/dependency&gt;
&lt;!--		引入通用mapper--&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;tk.mybatis&lt;/groupId&gt;
			&lt;artifactId&gt;mapper-spring-boot-starter&lt;/artifactId&gt;
			&lt;version&gt;2.1.5&lt;/version&gt;
		&lt;/dependency&gt;

		&lt;dependency&gt;
			&lt;groupId&gt;mysql&lt;/groupId&gt;
			&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
			&lt;scope&gt;runtime&lt;/scope&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
			&lt;scope&gt;test&lt;/scope&gt;
			&lt;exclusions&gt;
				&lt;exclusion&gt;
					&lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;
					&lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;
				&lt;/exclusion&gt;
			&lt;/exclusions&gt;
		&lt;/dependency&gt;
	&lt;/dependencies&gt;

	&lt;build&gt;
		&lt;plugins&gt;
			&lt;plugin&gt;
				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
				&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
			&lt;/plugin&gt;
			&lt;plugin&gt;
				&lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;
				&lt;artifactId&gt;mybatis-generator-maven-plugin&lt;/artifactId&gt;
				&lt;version&gt;1.3.6&lt;/version&gt;
				&lt;configuration&gt;
					&lt;configurationFile&gt;
						${basedir}/src/main/resources/generator/generatorConfig.xml
					&lt;/configurationFile&gt;
					&lt;overwrite&gt;true&lt;/overwrite&gt;
					&lt;verbose&gt;true&lt;/verbose&gt;
				&lt;/configuration&gt;
				&lt;dependencies&gt;
					&lt;dependency&gt;
						&lt;groupId&gt;mysql&lt;/groupId&gt;
						&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
						&lt;version&gt;8.0.19&lt;/version&gt;
					&lt;/dependency&gt;
					&lt;dependency&gt;
						&lt;groupId&gt;tk.mybatis&lt;/groupId&gt;
						&lt;artifactId&gt;mapper&lt;/artifactId&gt;
						&lt;version&gt;4.1.5&lt;/version&gt;
					&lt;/dependency&gt;
				&lt;/dependencies&gt;
			&lt;/plugin&gt;
		&lt;/plugins&gt;
	&lt;/build&gt;

&lt;/project&gt;

</code></pre>
<p>通用Mapper包扫描配置</p>
<pre><code class="language-java">import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import tk.mybatis.spring.annotation.MapperScan;//注意是tk的MapperScan注解

@SpringBootApplication
@MapperScan(&quot;com.itmuch&quot;)
public class UserCenterApplication {

	public static void main(String[] args) {
		SpringApplication.run(UserCenterApplication.class, args);
	}

}
</code></pre>
<p>在resources目录下新建generator目录，添加mybatis.generator配置</p>
<figure data-type="image" tabindex="11"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/9ijlzo.png" alt="" loading="lazy"></figure>
<p>generator/generatorConfig.xml</p>
<pre><code class="language-xml">&lt;!DOCTYPE generatorConfiguration
        PUBLIC &quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;&gt;

&lt;generatorConfiguration&gt;
    &lt;properties resource=&quot;generator/config.properties&quot;/&gt;

    &lt;context id=&quot;Mysql&quot; targetRuntime=&quot;MyBatis3Simple&quot; defaultModelType=&quot;flat&quot;&gt;
        &lt;property name=&quot;beginningDelimiter&quot; value=&quot;`&quot;/&gt;
        &lt;property name=&quot;endingDelimiter&quot; value=&quot;`&quot;/&gt;

        &lt;plugin type=&quot;tk.mybatis.mapper.generator.MapperPlugin&quot;&gt;
            &lt;property name=&quot;mappers&quot; value=&quot;tk.mybatis.mapper.common.Mapper&quot;/&gt;
            &lt;property name=&quot;caseSensitive&quot; value=&quot;true&quot;/&gt;
        &lt;/plugin&gt;

        &lt;jdbcConnection driverClass=&quot;${jdbc.driverClass}&quot;
                        connectionURL=&quot;${jdbc.url}&quot;
                        userId=&quot;${jdbc.user}&quot;
                        password=&quot;${jdbc.password}&quot;&gt;
        &lt;/jdbcConnection&gt;

        &lt;javaModelGenerator targetPackage=&quot;com.itmuch.usercenter.domain.entity.${moduleName}&quot;
                            targetProject=&quot;src/main/java&quot;/&gt;

        &lt;sqlMapGenerator targetPackage=&quot;com.itmuch.usercenter.dao.${moduleName}&quot;
                         targetProject=&quot;src/main/resources&quot;/&gt;

        &lt;javaClientGenerator targetPackage=&quot;com.itmuch.usercenter.dao.${moduleName}&quot;
                             targetProject=&quot;src/main/java&quot;
                             type=&quot;XMLMAPPER&quot;/&gt;

        &lt;table tableName=&quot;${tableName}&quot;&gt;
            &lt;generatedKey column=&quot;id&quot; sqlStatement=&quot;JDBC&quot;/&gt;
        &lt;/table&gt;
    &lt;/context&gt;
&lt;/generatorConfiguration&gt;
</code></pre>
<p>generator/config.properties</p>
<pre><code class="language-properties">jdbc.driverClass=com.mysql.cj.jdbc.Driver
# nullCatalogMeansCurrent=true 如果不加这个配置，出现表名user在其他库，比如系统库的，会生产系统库的user
jdbc.url=jdbc:mysql://localhost:3306/user_center?nullCatalogMeansCurrent=true
jdbc.user=root
jdbc.password=kim@2020

# 包名
moduleName=user
# 表名
tableName=user
</code></pre>
<p>application.yml</p>
<pre><code class="language-yaml">spring:
  datasource:
    url: jdbc:mysql://localhost:3306/user_center
    hikari:
      username: root
      password: kim@2020
      # &gt;=6.x com.mysql.cj.jdbc.Driver
      # &lt;=5.x com.mysql.jdbc.Driver
      driver-class-name: com.mysql.cj.jdbc.Driver
</code></pre>
<p>执行逆向生产代码</p>
<img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/sezcpm.png" style="zoom:50%;" />
<h4 id="整合lombok简化代码">整合Lombok简化代码</h4>
<pre><code class="language-xml">&lt;dependency&gt;
			&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
			&lt;artifactId&gt;lombok&lt;/artifactId&gt;
			&lt;version&gt;1.18.10&lt;/version&gt;
			&lt;scope&gt;provided&lt;/scope&gt;
		&lt;/dependency&gt;
</code></pre>
<p>常用注解</p>
<pre><code class="language-java">@Data
@NoArgsConstructor//生成无参构造
@AllArgsConstructor//为所有参数生成构造
@RequiredArgsConstructor//为final属性生成构造方法
@Builder //建造者模式
@Slf4j
</code></pre>
<p>更多查询<a href="https://projectlombok.org/">官网</a></p>
<p>在<a href="https://github.com/abel533/Mapper"><code>通用mapper</code></a> <a href="https://github.com/abel533/Mapper/wiki/4.1.mappergenerator"><code>wiki</code></a>搜<code>lombok</code>，看有没有生成支持<code>lombok</code>的配置</p>
<img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/5odMfS.png" style="zoom:50%;" />
<h5 id="mybatisgenerator添加lombok支持">mybatis.generator添加lombok支持</h5>
<pre><code class="language-xml">&lt;plugin type=&quot;tk.mybatis.mapper.generator.MapperPlugin&quot;&gt;
            &lt;property name=&quot;mappers&quot; value=&quot;tk.mybatis.mapper.common.Mapper&quot;/&gt;
            &lt;property name=&quot;caseSensitive&quot; value=&quot;true&quot;/&gt;
            &lt;property name=&quot;lombok&quot; value=&quot;Getter,Setter,ToString&quot;/&gt;&lt;!-- 添加的行 --&gt;
        &lt;/plugin&gt;
</code></pre>
<p>文档也说了，目前只支持<code>@Getter@Setter@ToString@Accessors(chain = true)</code>4种注解，一般我们自己的domain上还是习惯加如下注解：</p>
<pre><code class="language-java">@Data
@NoArgsConstructor//生成无参构造
@AllArgsConstructor//为所有参数生成构造
@Builder //建造者模式
</code></pre>
<p>可以手动加，更简单。</p>
<h4 id="解决idea的红色警告">解决IDEA的红色警告</h4>
<p>出现警告的原因：</p>
<p>IDEA是非常智能的，它可以理解Spring的上下文。然而 <code>UserMapper</code> 这个接口是Mybatis的，IDEA理解不了。</p>
<p>而 <code>@Autowired</code> 注解，默认情况下要求依赖对象（也就是 <code>userMapper</code> ）必须存在。而IDEA认为这个对象的实例/代理是个null，所以就<strong>友好地给个提示</strong>。</p>
<p>解决方法：参见这篇<a href="https://www.imooc.com/article/287865">手记</a></p>
<h5 id="作业1-课后研究一下resource和autowired注解">作业1: 课后研究一下@Resource和@Autowired注解</h5>
<h5 id="作业2-研究repository-component-service-controller之间的区别和联系">作业2: 研究@Repository、@Component、@Service、@Controller之间的区别和联系</h5>
<h4 id="编写用户微服务和内容微服务">编写用户微服务和内容微服务</h4>
<p>注意：核心业务，一定要设计好业务流程，分析的过程中，使用业务流程图、活动图、用例图、序列图。重视业务和建模，没有建模的微服务是没有灵魂的。</p>
<h5 id="实际开发流程">实际开发流程</h5>
<p>Schema First</p>
<p>1、分析业务（流程图、用例图...架构图等） 建模业务，确定架构</p>
<p>2、敲定业务流程（评审）</p>
<p>3、设计API/数据模型（表结构设计|类图|ER图）</p>
<p>4、编写API文档</p>
<p>5、编写代码</p>
<p>API First</p>
<p>1、分析业务（流程图、用例图...架构图等） 建模业务，确定架构</p>
<p>2、敲定业务流程（评审）</p>
<p>3、设计API/数据模型（表结构设计|类图|ER图）</p>
<p>4、编写代码</p>
<p>5、编写API文档</p>
<p>但是实际也不是完全按照这样等流程走。</p>
<p>编码。。。</p>
<h5 id="resttemplate的使用">RestTemplate的使用</h5>
<h4 id="现有架构存在的问题">现有架构存在的问题</h4>
<ul>
<li>硬编码IP，IP变化怎么办</li>
<li>如何实现负载均衡？</li>
<li>用户中心挂了怎么办？</li>
</ul>
<h2 id="spring-cloud介绍">Spring Cloud介绍</h2>
<h3 id="什么是spring-cloud-alibaba">什么是Spring Cloud Alibaba</h3>
<figure data-type="image" tabindex="12"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/s3ySrH.png" alt="" loading="lazy"></figure>
<ul>
<li>Spring Cloud的子项目</li>
<li>致力于提供微服务开发的一站式解决方案
<ul>
<li>包含微服务开发的必备组件</li>
<li>基于Spring Cloud，符合Spring Cloud标准</li>
<li>阿里的微服务解决方案</li>
</ul>
</li>
</ul>
<h3 id="版本与兼容性">版本与兼容性</h3>
<ul>
<li>Spring Cloud 版本命名</li>
<li>Spring Cloud 生命周期</li>
<li>Spring Boot 、Spring Cloud、Spring Cloud Alibaba的兼容性关系</li>
<li>生产环境怎么选择版本？</li>
</ul>
<h4 id="spring-cloud-版本命名">Spring Cloud 版本命名</h4>
<p>语义化</p>
<p>2.1.13.RELEASE</p>
<p>2：主版本，第几代</p>
<p>1：次版本，一些功能的增加，但是架构没有太大变化，是兼容的</p>
<p>13：增量版本，bug修复</p>
<p>RELEASE：里程碑。SNAPSHOT：开发版 ，M：里程碑 ，RELEASE：正式版</p>
<p>Greenwich SR1 ：Greenwich版本的第一个bug修复版</p>
<p>SR：Service Release bug修复</p>
<p>Release Train. 发布列车</p>
<p>伦敦地铁站站名。避免混淆，噱头。</p>
<p>Greenwich RELEASE： Greenwich版本的第一个正式版</p>
<h4 id="spring-cloud-生命周期">Spring Cloud 生命周期</h4>
<ul>
<li>版本发布规划
<ul>
<li>https://github.com/spring-cloud/spring-cloud-release/milestones</li>
</ul>
</li>
<li>版本发布记录
<ul>
<li>https://github.com/spring-cloud/spring-cloud-release/release</li>
</ul>
</li>
<li>版本终止声明
<ul>
<li>https://spring.io/projects/spring-cloud#overview</li>
</ul>
</li>
</ul>
<h4 id="版本兼容性">版本兼容性</h4>
<figure data-type="image" tabindex="13"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/gF4NW5.png" alt="" loading="lazy"></figure>
<p>https://spring.io/projects/spring-cloud-alibaba#overview</p>
<p>https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</p>
<h4 id="生产环境怎么选择版本">生产环境怎么选择版本？</h4>
<ul>
<li>坚决不用非稳定版本/end-of-life版本</li>
<li>尽量用最新一代
<ul>
<li>xxx.RELEASE版本缓一缓</li>
<li>SR2之后一般可大规模使用</li>
</ul>
</li>
</ul>
<h3 id="整合spring-cloud-alibaba">整合Spring Cloud Alibaba</h3>
<ul>
<li><a href="https://cloud.spring.io/spring-cloud-static/Greenwich.SR1/single/spring-cloud.html#_client_side_usage">整合Spring Cloud</a></li>
<li><a href="https://spring.io/projects/spring-cloud-alibaba#overview">整合Spring Cloud Alibaba</a></li>
</ul>
<p>整合好后，引入组件不需要指定版本</p>
<h2 id="服务发现">服务发现</h2>
<h3 id="服务提供者与服务消费者">服务提供者与服务消费者</h3>
<table>
<thead>
<tr>
<th>名次</th>
<th>定义</th>
</tr>
</thead>
<tbody>
<tr>
<td>服务提供者</td>
<td>服务的被调用方（即：为其他微服务提供接口的微服务）</td>
</tr>
<tr>
<td>服务消费者</td>
<td>服务的调用方（即：调用其他微服务接口的微服务）</td>
</tr>
</tbody>
</table>
<h3 id="如何让服务消费者感知到服务提供者">如何让服务消费者感知到服务提供者</h3>
<figure data-type="image" tabindex="14"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/3iJUdW.png" alt="" loading="lazy"></figure>
<p>服务消费者内部使用定时任务去服务发现组件获取提供者信息，并缓存到本地，服务消费者每次调用服务提供者从本地缓存那提供者信息。</p>
<figure data-type="image" tabindex="15"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/WNeJFv.png" alt="" loading="lazy"></figure>
<p>添加心跳机制，通过心跳机制改变服务状态</p>
<h3 id="什么是nacos">什么是Nacos</h3>
<p><a href="https://nacos.io/zh-cn/docs/what-is-nacos.html">官网什么是Nacos</a></p>
<figure data-type="image" tabindex="16"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/DDmYIw.png" alt="" loading="lazy"></figure>
<h3 id="搭建nacos-server">搭建Nacos Server</h3>
<p>选择<code>Nacos Server</code>版本</p>
<p>查看引入到<code>spring-cloud-alibaba-dependencie</code>依赖</p>
<img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/cneRHA.png" style="zoom:63%;" />
<ul>
<li>下载地址
<ul>
<li>https://github.com/alibaba/nacos/releases</li>
</ul>
</li>
<li>搭建Nacos Server
<ul>
<li>参考文档：https://nacos.io/zh-cn/docs/quick-start.html</li>
</ul>
</li>
</ul>
<p>启动服务器</p>
<p><code>startup.sh -m standalone</code></p>
<p>访问控制台</p>
<p>http://localhost:8848/nacos</p>
<p>默认用户名密码都是nacos</p>
<h3 id="将应用注册到nacos">将应用注册到Nacos</h3>
<ul>
<li>用户中心注册到Nacos</li>
<li>内容中心注册到Nacos</li>
<li>测试：内容中心总能找到用户中心</li>
</ul>
<p>引入依赖</p>
<pre><code class="language-xml">&lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<p>配置</p>
<pre><code class="language-yaml">spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
  application:
    # 服务名称尽量用-，不要用_，不要用特殊字符
    name: content-center
</code></pre>
<h3 id="引入服务发现">引入服务发现</h3>
<pre><code class="language-java">@Slf4j
@Service
@RequiredArgsConstructor(onConstructor = @__(@Autowired))
public class ShareService {
    private final ShareMapper shareMapper;

    private final RestTemplate restTemplate;

    private final DiscoveryClient discoveryClient;

    public ShareDto findById(Integer id){
        //获取分享详情
        Share share = this.shareMapper.selectByPrimaryKey(id);
        //发布人id
        Integer userId = share.getUserId();
        //用户中心所有实例的信息
        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(&quot;user-center&quot;);
        String targetURL = instances.stream()
                .map(instance -&gt; instance.getUri().toString() + &quot;/users/{id}&quot;)
                .findFirst()
                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;当前没有实例！&quot;));

        log.info(&quot;请求的目标地址：{}&quot;, targetURL);
        UserDto userDto = restTemplate.getForObject(
                targetURL,
                UserDto.class,
                userId);
        ShareDto shareDto = new ShareDto();

        //消息的装配
        BeanUtils.copyProperties(share, shareDto);
        shareDto.setWxNickName(userDto.getWxNickname());
        return shareDto;
    }
}
</code></pre>
<h3 id="nacos服务发现的领域模型">Nacos服务发现的领域模型</h3>
<figure data-type="image" tabindex="17"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/IIbYWQ.png" alt="" loading="lazy"></figure>
<p>Namespace：只要用来实现环境隔离，默认public</p>
<p>Group：默认DEFAULT_GROUP，管理服务分组</p>
<p>Service：微服务</p>
<p>Cluster：微服务集群，对指定微服务的虚拟划分</p>
<p>Instance：微服务实例</p>
<h4 id="如何使用">如何使用</h4>
<p>Namespace，在控制台页面创建。配置的时候使用生成的uuid。</p>
<pre><code class="language-yaml">spring:
  cloud:
    nacos:
      discovery:
        # 指定nacos server的地址
        server-addr: localhost:8848
        cluster-name: BJ
        namespace: 56116141-d837-4d15-8842-94e153bb6cfb
</code></pre>
<h3 id="nacos元数据">Nacos元数据</h3>
<ul>
<li>官方描述：https://nacos.io/zh-ch/docs/concepts.html</li>
<li>级别：【服务级别、集群级别、实例级别】</li>
</ul>
<p>元数据的作用：</p>
<ul>
<li>提供描述信息</li>
<li>让微服务调用更灵活
<ul>
<li>例如：微服务版本控制</li>
</ul>
</li>
</ul>
<p>如何为微服务设置元数据</p>
<ul>
<li>控制台界面</li>
<li>配置文件指定</li>
</ul>
<pre><code class="language-yaml">spring:
  cloud:
    nacos:
      discovery:
        # 指定nacos server的地址
        server-addr: localhost:8848
        cluster-name: BJ
        namespace: 56116141-d837-4d15-8842-94e153bb6cfb
        metadata:
          instance: c
          haha: hehe
          version: 1
</code></pre>
<h2 id="实现负载均衡-ribbon">实现负载均衡-Ribbon</h2>
<h3 id="负载均衡的两种方式">负载均衡的两种方式</h3>
<ul>
<li>服务端负载均衡</li>
<li>客户端负载均衡（客户端调用的时候使用选择负载均衡算法）</li>
</ul>
<h3 id="手写一个客户端负载均衡器">手写一个客户端负载均衡器</h3>
<p>改写一下<code>ShareService</code>的<code>findById</code>方法。从<code>Nacos</code>获取到<code>URL</code>列表，然后随机从列表中取一个作为本次请求的服务提供者实例。</p>
<pre><code class="language-java">List&lt;String&gt; targetURLs = instances.stream()
                .map(instance -&gt; instance.getUri().toString() + &quot;/users/{id}&quot;).collect(Collectors.toList());

        int i = ThreadLocalRandom.current().nextInt(targetURLs.size());
        String targetURL= targetURLs.get(i);
</code></pre>
<p>随后启动content-center</p>
<h4 id="启动多个user-center">启动多个user-center</h4>
<p>配置允许并行运行</p>
<figure data-type="image" tabindex="18"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/Uz9a20.png" alt="" loading="lazy"></figure>
<p>修改端口，运行启动类</p>
<pre><code class="language-yaml">server:
  port: 8082
</code></pre>
<h3 id="使用ribbon实现负载均衡">使用Ribbon实现负载均衡</h3>
<ul>
<li>Ribbon是什么</li>
<li>引入Ribbon后到架构演进</li>
<li>整合Ribbon实现负载均衡</li>
</ul>
<h4 id="ribbon是什么">Ribbon是什么</h4>
<p>负载均衡器</p>
<h4 id="架构演进">架构演进</h4>
<figure data-type="image" tabindex="19"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/Gjk65Z.png" alt="" loading="lazy"></figure>
<h4 id="整合ribbon实现负载均衡">整合Ribbon实现负载均衡</h4>
<p>引入Nacos</p>
<figure data-type="image" tabindex="20"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/QOcDIR.png" alt="" loading="lazy"></figure>
<p>我们引入<code>spring-cloud-starter-alibaba-nacos-discovery</code>时，已经引入了<code>Ribbon</code>。</p>
<p>直接使用就行了。</p>
<p>写注解</p>
<pre><code class="language-java">@Bean
@LoadBalanced
public RestTemplate restTemplate(){
  return new RestTemplate();
}
</code></pre>
<p>配置<code>RestTemplate</code>的地方添加<code>@LoadBalanced</code>注解即可。</p>
<h4 id="使用">使用</h4>
<pre><code class="language-java">UserDto userDto = restTemplate.getForObject(
                &quot;http://user-center/users/{userId}&quot;,
                UserDto.class,
                userId);
</code></pre>
<h3 id="ribbon组成">Ribbon组成</h3>
<p><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/jUK5ij.png" alt="" loading="lazy">先有个印象。二次开发再回头看</p>
<h3 id="ribbon内置的负载均衡规则">Ribbon内置的负载均衡规则</h3>
<figure data-type="image" tabindex="21"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200411121526731.png" alt="" loading="lazy"></figure>
<p>默认是ZoneAvoidanceRule。</p>
<p>每一个负载均衡算法源码都值得看一下。</p>
<h3 id="细粒度配置自定义">细粒度配置自定义</h3>
<ul>
<li>Java代码配置</li>
<li>用配置属性配置</li>
<li>最佳实践总结</li>
</ul>
<p>场景：当内容中心调用用户中心微服务的时候使用随机负载，当内容中心调用其他微服务的时候使用默认负载均衡策略。</p>
<h4 id="java代码配置">Java代码配置</h4>
<p>新建配置类，注册一个RandomRule。</p>
<pre><code class="language-java">package ribbonconfiguration;

import com.netflix.loadbalancer.IRule;
import com.netflix.loadbalancer.RandomRule;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * 配置类所在的包必须是和启动类不一样的包
 */
@Configuration
public class RibbonConfiguration {

    @Bean
    public IRule ribbonRule(){
        return new RandomRule();
    }
}
</code></pre>
<p>新建一个<code>user-center</code>的<code>ribbon</code>负载配置类，配置规则使用上面的随机规则。</p>
<pre><code class="language-java">package com.itmuch.contentcenter.configuration;

import org.springframework.cloud.netflix.ribbon.RibbonClient;
import org.springframework.context.annotation.Configuration;
import ribbonconfiguration.RibbonConfiguration;

@Configuration
@RibbonClient(name = &quot;user-center&quot;,configuration = RibbonConfiguration.class)
public class UserCenterRibbonConfiguration {
}
</code></pre>
<p><code>@RibbonClient</code>注解配置<code>Ribbon</code>自定义配置</p>
<p><code>name=&quot;user-center&quot;</code>表示为<code>user-center</code>配置的。</p>
<p><code>configuration = RibbonConfiguration.class</code>用来指定负载均衡算法，或者负载均衡规则</p>
<h5 id="父子上下文">父子上下文</h5>
<p>这里的上下文是指<code>Spring Context</code>。</p>
<p>启动类拥有一个上下文，是父上下文，Ribbon会启动一个子上下文，<strong>父子上下文不能重叠</strong>。</p>
<p>启动类的上下文，会扫描启动类所在包及子包下的Bean。</p>
<p><code>Ribbon</code>的配置类不能被启动类的上下文扫描到。因为<code>Spring context</code>是一个树状上下文。父子上下文扫描到包如果重叠会有各种问题。比如，<a href="https://blog.csdn.net/qq_32588349/article/details/52097943"><strong>导致事务不生效</strong></a>。</p>
<p><strong>如果上面配置的RibbonConfiguration在启动类扫描范围内，会导致自定义配置失效，RibbonConfiguration配置的随机负载均衡全局生效。</strong></p>
<h4 id="配置属性方式">配置属性方式</h4>
<pre><code class="language-yaml">user-center:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule
</code></pre>
<p>这种方式没有上下文重叠的坑</p>
<h4 id="两种配置方式的对比">两种配置方式的对比</h4>
<figure data-type="image" tabindex="22"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200411175449054.png" alt="image-20200411175449054" loading="lazy"></figure>
<h4 id="细粒度配置最佳实践">细粒度配置最佳实践</h4>
<ul>
<li>尽量使用属性配置，属性方式实现不了的情况下再考虑用代码配置</li>
<li>在同一个微服务内尽量保持单一性，比如统一使用属性配置，不要两种方式混用，增加定位代码的复杂性</li>
</ul>
<h3 id="全局配置">全局配置</h3>
<ul>
<li>方式一：让<code>ComponentScan</code>上下文重叠（强烈不建议使用）</li>
<li>方式二：唯一正确的途径：<code>@RibbonClients(defaultConfiguration = xxx.class)</code></li>
</ul>
<pre><code class="language-java">package com.itmuch.contentcenter.configuration;

import org.springframework.cloud.netflix.ribbon.RibbonClients;
import org.springframework.context.annotation.Configuration;
import ribbonconfiguration.RibbonConfiguration;

@Configuration
@RibbonClients(defaultConfiguration = RibbonConfiguration.class)
public class UserCenterRibbonConfiguration {
}
</code></pre>
<h3 id="支持的配置项">支持的配置项</h3>
<p>Java Config方式：见<code>Ribbon组成</code>一节的接口</p>
<p>配置文件方式：</p>
<figure data-type="image" tabindex="23"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200411180522524.png" alt="image-20200411180522524" loading="lazy"></figure>
<h3 id="饥饿加载">饥饿加载</h3>
<p>默认是懒加载，在调用<code>restTemplate</code>时才会创建一个叫<code>user-center</code>的<code>Ribbon Client</code></p>
<blockquote>
<p><code>user-center</code>是要调用的客户端名字</p>
</blockquote>
<p>懒加载的问题：在第一次调用<code>user-center</code>的接口时，访问会慢。</p>
<p>可以使用饥饿加载避免这个问题。</p>
<pre><code class="language-yaml">ribbon:
  eager-load:
    enabled: true
    clients: user-center
</code></pre>
<h3 id="扩展ribbon">扩展Ribbon</h3>
<h4 id="支持nacos权重">支持Nacos权重</h4>
<p>首先了解一下，Nacos的权重在<code>0-1</code>之间，<code>1</code>最大</p>
<p>Ribbon内置的负载均衡规则都不支持Nacos的权重，需要自己定义一个负载均衡规则。</p>
<pre><code class="language-java">@Slf4j
public class NacosWeightedRule extends AbstractLoadBalancerRule {

    @Autowired
    private NacosDiscoveryProperties nacosDiscoveryProperties;

    @Override
    public void initWithNiwsConfig(IClientConfig iClientConfig) {
        //读取配置文件，并初始化当前配置NacosWeightedRule，一般不需要实现
    }

    @Override
    public Server choose(Object key) {
        BaseLoadBalancer loadBalancer = (BaseLoadBalancer) this.getLoadBalancer();
        log.info(&quot;loadBalancer = {}&quot;, loadBalancer);

        //想要请求的微服务的名称
        String name = loadBalancer.getName();

        //实现负载均衡算法
        //这里不自己实现，直接使用nacos提供的
        //拿到服务发现的相关API
        NamingService namingService = nacosDiscoveryProperties.namingServiceInstance();
        try {
            Instance instance = namingService.selectOneHealthyInstance(name);
            log.info(&quot;选择的实例是：port = {}, instance = {}&quot;, instance.getPort(), instance);
            return new NacosServer(instance);
        } catch (NacosException e) {
            return null;
        }
    }
}
</code></pre>
<p>配置为全局规则</p>
<pre><code class="language-java">/**
 * 配置类所在的包必须是和启动类不一样的包
 */
@Configuration
public class RibbonConfiguration {

    @Bean
    public IRule ribbonRule(){
        return new NacosWeightedRule();
    }
}
</code></pre>
<p>更多扩展方式可以<a href="https://www.imooc.com/article/288660"><strong>扩展Ribbon支持Nacos权重的三种方式</strong></a></p>
<h4 id="同一集群优先调用">同一集群优先调用</h4>
<p>为了实现容灾，把内容中心和用户中心部署在北京机房和南京机房里，希望调用的时候同机房优先。</p>
<p>使用Nacos服务发现领域模型里的Cluster</p>
<p>编写同集群优先调用规则</p>
<pre><code class="language-java">@Slf4j
public class NacosSameClusterWeightedRule extends AbstractLoadBalancerRule {
    @Autowired
    private NacosDiscoveryProperties nacosDiscoveryProperties;
    @Override
    public void initWithNiwsConfig(IClientConfig iClientConfig) {

    }

    @Override
    public Server choose(Object key) {
        //拿到配置文件中的集群名称
        String clusterName = nacosDiscoveryProperties.getClusterName();
        BaseLoadBalancer loadBalancer = (BaseLoadBalancer) this.getLoadBalancer();
        log.info(&quot;loadBalancer = {}&quot;, loadBalancer);

        //想要请求的微服务的名称
        String name = loadBalancer.getName();

        //拿到服务发现的相关API
        NamingService namingService = nacosDiscoveryProperties.namingServiceInstance();
        try {
            //1 找到指定服务的所有实例
            List&lt;Instance&gt; instances = namingService.selectInstances(name, true);
            //2 过滤出相同集群下的所有实例
            Stream&lt;Instance&gt; instanceStream = instances.stream()
                    .filter(instance -&gt; Objects.equals(instance.getClusterName(), clusterName));
            List&lt;Instance&gt; sameClusterInstances = instanceStream.collect(Collectors.toList());

            List&lt;Instance&gt; instancesToBeChosen;
            if(CollectionUtils.isEmpty(sameClusterInstances)){
                instancesToBeChosen = instances;
                log.warn(&quot;发生跨集群调用，name = {}, clusterName = {}, instances = {}&quot;,
                        name,
                        clusterName,
                        instances);
            }else {
                instancesToBeChosen = sameClusterInstances;
            }
            //3 基于权重的负载均衡算法，返回1个实例
            Instance instance = ExtendBalancer.getHostByRandomWeight2(instancesToBeChosen);
            log.info(&quot;选择的实例是 port = {}, instances = {} &quot;,instance.getPort(), instance);

            return new NacosServer(instance);
        } catch (NacosException e) {
            log.error(&quot;发生异常&quot;,e);
        }
        return null;
    }
}

class ExtendBalancer extends Balancer{
    //Nacos没有暴露从实例列表中选一个，只有selectOneHealthyInstance
    public static Instance getHostByRandomWeight2(List&lt;Instance&gt; hosts) {
        return getHostByRandomWeight(hosts);
    }
}
</code></pre>
<p>配置全局<code>NacosSameClusterWeightedRule</code></p>
<pre><code class="language-java">@Configuration
public class RibbonConfiguration {

    @Bean
    public IRule ribbonRule(){
        return new NacosSameClusterWeightedRule();
    }
}
</code></pre>
<p>配置所在集群</p>
<pre><code class="language-yaml">spring:
  datasource:
    url: jdbc:mysql://localhost:3306/content_center
    hikari:
      username: root
      password: kim@2020
      # &gt;=6.x com.mysql.cj.jdbc.Driver
      # &lt;=5.x com.mysql.jdbc.Driver
      driver-class-name: com.mysql.cj.jdbc.Driver
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        cluster-name: BJ
  application:
    # 服务名称尽量用-，不要用_，不要用特殊字符
    name: content-center

logging:
  level:
    com.itmuch.usercenter.dao.content: debug

server:
  servlet:
    context-path:
  port: 8010

#user-center:
#  ribbon:
#    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule
ribbon:
  eager-load:
    enabled: true
    clients: user-center
</code></pre>
<p>启动内容中心服务</p>
<p>接下来，配置两个用户中心服务，分别配置不同的集群和端口</p>
<pre><code class="language-yaml">spring:
  datasource:
    url: jdbc:mysql://localhost:3306/user_center
    hikari:
      username: root
      password: kim@2020
      # &gt;=6.x com.mysql.cj.jdbc.Driver
      # &lt;=5.x com.mysql.jdbc.Driver
      driver-class-name: com.mysql.cj.jdbc.Driver
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        # 多集群配置
        cluster-name: BJ
  application:
    # 服务名称尽量用-，不要用_，不要用特殊字符
    name: user-center

logging:
  level:
    com.itmuch.usercenter.dao.user: debug
server:
  # 本地启动多个实例，启动前记得改端口
  port: 8081
</code></pre>
<p>查看Nacos控制台</p>
<figure data-type="image" tabindex="24"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412103656785.png" alt="image-20200412103656785" loading="lazy"></figure>
<p>观察到<code>user-center</code>的集群数目是2。点击详情</p>
<figure data-type="image" tabindex="25"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412103753967.png" alt="image-20200412103753967" loading="lazy"></figure>
<p>页面访问请求http://localhost:8010/shares/1</p>
<img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412103847501.png" alt="image-20200412103847501" style="zoom:50%;" />
<p>可以看到总是请求到相同机房的实例（8081也属于BJ集群）。</p>
<p>模拟BJ集群下线。选择Nacos控制台里BJ集群的8081实例，将其下线。</p>
<p>再次浏览器访问http://localhost:8010/shares/1</p>
<p>可以观察到已经请求到了异地机房的NJ机房的实例8082</p>
<figure data-type="image" tabindex="26"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412104229107.png" alt="image-20200412104229107" loading="lazy"></figure>
<h4 id="番外为开源项目贡献代码">番外：为开源项目贡献代码</h4>
<p>目前同集群优先调用规则已经在新版本中被采纳了，可以直接配置。我用的是2.1.0.RELEASE版本</p>
<figure data-type="image" tabindex="27"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412104443239.png" alt="image-20200412104443239" loading="lazy"></figure>
<p>同集群优先调用规则的类是<code>com.alibaba.cloud.nacos.ribbon.NacosRule</code>,直接配置这个类使用，不需要再扩展了。</p>
<h3 id="基于元数据的版本控制">基于元数据的版本控制</h3>
<p>配置元数据，只要在<code>spring.cloud.nacos.discovery.metadata</code>下配置<code>key-value</code>对就可以</p>
<pre><code class="language-yaml">spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        cluster-name: BJ
        metadata:
          version: v1.0
</code></pre>
<p>核心逻辑是，服务提供者和服务消费者配置相同的或不同的<code>version</code>元数据，在服务消费者请求服务提供者的时候，从待选实例中过滤一下，找到相同版本号的实例列表，再用一种负载算法从从版本号列表中选一个实例。</p>
<pre><code class="language-java">String version = nacosDiscoveryProperties.getMetadata().get(&quot;version&quot;);
NamingService namingService = nacosDiscoveryProperties.namingServiceInstance();
        try {
            //1 找到指定服务的所有实例
            List&lt;Instance&gt; instances = namingService.selectInstances(name, true);
            //过滤出同集群的实例列表
            //过滤出版本号相同的实例列表
            List&lt;Instance&gt; sameVersionInstances = instancesToBeChosen.stream()
                    .filter(instance -&gt; Objects.equals(instance.getMetadata().get(&quot;version&quot;), version))
                    .collect(Collectors.toList());
            //从列表中选出一个实例
          Instance instance = ExtendBalancer.getHostByRandomWeight2(instancesToBeChosen);
</code></pre>
<p>具体实现参见<a href="https://www.imooc.com/article/288674">手记</a></p>
<h3 id="深入理解namespace">深入理解Namespace</h3>
<p>配置namespace</p>
<figure data-type="image" tabindex="28"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412110517289.png" alt="image-20200412110517289" loading="lazy"></figure>
<pre><code class="language-yaml">spring:
  datasource:
    url: jdbc:mysql://localhost:3306/content_center
    hikari:
      username: root
      password: kim@2020
      # &gt;=6.x com.mysql.cj.jdbc.Driver
      # &lt;=5.x com.mysql.jdbc.Driver
      driver-class-name: com.mysql.cj.jdbc.Driver
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        cluster-name: BJ
        metadata:
          version: v1.0
        # 指定namespace
        namespace: bc4f4e1a-bf4e-4bcc-86f1-7f6252f81e45
  application:
    # 服务名称尽量用-，不要用_，不要用特殊字符
    name: content-center
</code></pre>
<p>跨namespace不能调用</p>
<p>在用户中心和内容中心分别配上同样的命名空间ID。才可以正常访问。</p>
<h3 id="现有架构存在的问题-2">现有架构存在的问题</h3>
<ol>
<li>代码不可读</li>
<li>复杂的url难以维护</li>
<li>难以响应需求变化，变化没有幸福感</li>
<li>编程体验不统一</li>
</ol>
<h2 id="声明式http客户端feign">声明式HTTP客户端Feign</h2>
<ul>
<li>Feign是Netflix开源的声明式HTTP客户端</li>
<li>Github地址
<ul>
<li>https://github.com/openfeign/feign</li>
</ul>
</li>
</ul>
<h3 id="使用feign实现远程http调用">使用Feign实现远程HTTP调用</h3>
<h4 id="引入依赖">引入依赖</h4>
<pre><code class="language-xml">&lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<h4 id="写注解">写注解</h4>
<p>启动类上加上<code>@EnableFeignClients</code>注解</p>
<h4 id="写配置">写配置</h4>
<p>暂时没有</p>
<p>实现一个Feign接口</p>
<pre><code class="language-java">@FeignClient(name = &quot;user-center&quot;)
public interface UserCenterFeignClient {

    /**
     * http://user-center/users/{id}
     * @param id
     * @return
     */
    @GetMapping(&quot;/users/{id}&quot;)
    UserDto findById(@PathVariable Integer id);
}
</code></pre>
<pre><code class="language-java">@Slf4j
@Service
@RequiredArgsConstructor(onConstructor = @__(@Autowired))
public class ShareService {
    private final ShareMapper shareMapper;

    private final UserCenterFeignClient userCenterFeignClient;

    public ShareDto findById(Integer id){
        //获取分享详情
        Share share = this.shareMapper.selectByPrimaryKey(id);
        //发布人id
        Integer userId = share.getUserId();

        UserDto userDto = this.userCenterFeignClient.findById(userId);
        ShareDto shareDto = new ShareDto();

        //消息的装配
        BeanUtils.copyProperties(share, shareDto);
        shareDto.setWxNickName(userDto.getWxNickname());
        return shareDto;
    }
}
</code></pre>
<p>所谓的声明式HTTP客户端，就是只需要声明一个Feign Client接口，Feign就会根据声明的接口，自动帮我们构造请求的目标地址，并帮助你请求。</p>
<h3 id="feign的组成">Feign的组成</h3>
<figure data-type="image" tabindex="29"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412165849453.png" alt="image-20200412165849453" loading="lazy"></figure>
<h3 id="细粒度配置自定义-2">细粒度配置自定义</h3>
<p>默认Feign不打印任何日志，可以自定义Feign日志级别，让其打印日志</p>
<p>Feign日志级别</p>
<figure data-type="image" tabindex="30"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412170429751.png" alt="image-20200412170429751" loading="lazy"></figure>
<h4 id="java配置方式">Java配置方式</h4>
<p>UserCenterFeignConfiguration</p>
<pre><code class="language-java">/**
 * feign的配置类，最佳实践不要加@Configuration注解，否则必须挪到@ComponentScan能扫描的包以外。
 * 是因为重复扫描，父子上下文的问题
 */
public class UserCenterFeignConfiguration {

    @Bean
    public Logger.Level level(){
        //打印所有请求的细节
        return Logger.Level.FULL;
    }
}
</code></pre>
<p>UserCenterFeignClient</p>
<pre><code class="language-java">@FeignClient(name = &quot;user-center&quot;, configuration = UserCenterFeignConfiguration.class)
public interface UserCenterFeignClient {

    /**
     * http://user-center/users/{id}
     * @param id
     * @return
     */
    @GetMapping(&quot;/users/{id}&quot;)
    UserDto findById(@PathVariable Integer id);
}
</code></pre>
<pre><code class="language-yaml">logging:
  level:
    com.itmuch.usercenter.dao.content: debug
    com.itmuch.contentcenter.feignclient.UserCenterFeignClient: debug
</code></pre>
<h4 id="属性方式配置">属性方式配置</h4>
<pre><code class="language-yaml">feign:
  client:
    config:
      # 想要调用的微服务的名称
      user-center:
        loggerLevel: full
</code></pre>
<h3 id="全局配置-2">全局配置</h3>
<h4 id="代码方式">代码方式</h4>
<p>将细粒度的配置方式都注释掉</p>
<p>在启动类配置上全局配置</p>
<pre><code class="language-java">@EnableFeignClients(defaultConfiguration = UserCenterFeignConfiguration.class)
</code></pre>
<h4 id="配置属性方式-2">配置属性方式</h4>
<pre><code class="language-yaml">feign:
  client:
    config:
      default:
        loggerLevel: full
</code></pre>
<h3 id="支持的配置项-2">支持的配置项</h3>
<p>代码方式</p>
<figure data-type="image" tabindex="31"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412173444979.png" alt="image-20200412173444979" loading="lazy"></figure>
<p>属性配置方式</p>
<figure data-type="image" tabindex="32"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412173508756.png" alt="image-20200412173508756" loading="lazy"></figure>
<h3 id="配置最佳实践">配置最佳实践</h3>
<h4 id="ribbon配置-vs-feign配置">Ribbon配置 vs Feign配置</h4>
<p>Ribbon是一个负载均衡器，帮我们选择一个实例</p>
<p>Feign是一个声明式HTTP客户端，帮助我们更优雅的请求</p>
<figure data-type="image" tabindex="33"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412175511967.png" alt="image-20200412175511967" loading="lazy"></figure>
<h4 id="feign代码方式vs属性方式">Feign代码方式vs属性方式</h4>
<figure data-type="image" tabindex="34"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412175730431.png" alt="image-20200412175730431" loading="lazy"></figure>
<p>优先级：全局代码&lt;全局属性&lt;细粒度代码&lt;细粒度属性</p>
<h4 id="最佳实践-3">最佳实践</h4>
<ul>
<li>尽量使用属性配置，属性方式实现不了的情况再考虑用代码配置</li>
<li>在同一个微服务内尽量保持单一性，比如统一使用属性配置，不要两种方式混用，增加定位代码的复杂性</li>
</ul>
<h3 id="feign的继承">Feign的继承</h3>
<p>这个特性带来了紧耦合，因为在微服务间共享接口，官方不建议使用。</p>
<p>现状：很多公司用，代码复用。</p>
<p>新项目如何选择：权衡利弊，会得到什么好处，失去什么，是不是划算，划算就上。</p>
<h3 id="多参数请求构造">多参数请求构造</h3>
<p><a href="https://www.imooc.com/article/289000">如何使用Feign构造多参数的请求</a></p>
<p>Get请求参数使用@SpringQueryMap注解</p>
<pre><code class="language-java">@FeignClient(name = &quot;user-center&quot;)
public interface TestUserCenterFeignClient {

    @GetMapping(&quot;/q&quot;)
    UserDto query(@SpringQueryMap UserDto userDto);
}
</code></pre>
<p>Post请求多参数，也可以使用@RequestBody。</p>
<h3 id="feign脱离ribbon使用">Feign脱离Ribbon使用</h3>
<pre><code class="language-java">@FeignClient(name = &quot;baidu&quot;, url=&quot;http://www.baidu.com&quot;)
public interface TestBaiduFeignClient {

    @GetMapping(&quot;&quot;)
    String index();
}
</code></pre>
<pre><code class="language-java">@GetMapping(&quot;baidu&quot;)
    public String baiduIndex(){
        return this.testBaiduFeignClient.index();
    }
</code></pre>
<h3 id="resttemplate-vs-feign">RestTemplate vs Feign</h3>
<figure data-type="image" tabindex="35"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412205018818.png" alt="image-20200412205018818" loading="lazy"></figure>
<p>如何选择？</p>
<ul>
<li>原则：尽量用Feign，杜绝使用RestTemplate</li>
</ul>
<p>尽量减少开发人员的选择，共存会带来风格的不统一，额外的学习成本和额外的代码理解成本</p>
<ul>
<li>事无绝对，合理选择</li>
</ul>
<p>Feign解决不了，才用RestTemplate</p>
<h3 id="feign的性能优化">Feign的性能优化</h3>
<ul>
<li>连接池【提升15%左右】，默认使用URLConnection，可以修改</li>
</ul>
<p>可以选用httpclient或者okhttp</p>
<p>添加依赖</p>
<pre><code class="language-xml">&lt;dependency&gt;
            &lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;
            &lt;artifactId&gt;feign-httpclient&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;
            &lt;artifactId&gt;feign-okhttp&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<pre><code class="language-yaml">feign:
  client:
    config:
      default:
        loggerLevel: full
  httpclient:
    # 让feign使用apache httpclient做请求，而不是默认的urlclient
    enabled: true
    # feign的最大连接数
    max-connections: 200
    # feign单个路径的最大连接数
    max-connections-per-route: 50
  okhttp:
    enabled: true
    # feign的最大连接数
    max-connections: 200
    # feign单个路径的最大连接数
    max-connections-per-route: 50
</code></pre>
<ul>
<li>日志级别</li>
</ul>
<p>生产环境建议设置为basic</p>
<h3 id="feign常见问题总结">Feign常见问题总结</h3>
<p><a href="https://www.imooc.com/article/289005">常见问题总结</a></p>
<h3 id="现有架构总结">现有架构总结</h3>
<figure data-type="image" tabindex="36"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412210834103.png" alt="image-20200412210834103" loading="lazy"></figure>
<h2 id="服务容错-sentinel">服务容错-Sentinel</h2>
<p>雪崩效应：基础服务故障，导致导致上层服务故障，并且故障不断放大。又称为cascading failure，级联失效，级联故障。</p>
<figure data-type="image" tabindex="37"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200412211328332.png" alt="image-20200412211328332" loading="lazy"></figure>
<p>雪崩效应是因为服务没有做好容错。</p>
<h3 id="常见的容错方案容错思想">常见的容错方案（容错思想）</h3>
<ul>
<li>超时</li>
<li>限流</li>
<li>仓壁模式（线程池隔离）</li>
<li>断路器模式</li>
</ul>
<p>5秒内错误率、错误次数达到就跳闸。</p>
<p>断路器三态：</p>
<figure data-type="image" tabindex="38"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200418230211926.png" alt="image-20200418230211926" loading="lazy"></figure>
<h3 id="使用sentinel实现容错">使用Sentinel实现容错</h3>
<p>是什么：轻量级的流量控制、熔断降级Java库。</p>
<h3 id="整合sentinel">整合Sentinel</h3>
<pre><code class="language-xml">&lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<p>可以使用/actuator/sentinel断点查看sentinel相关信息。</p>
<h3 id="整合actuator">整合Actuator</h3>
<pre><code class="language-xml">&lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre>
<p>需要加入配置才能暴露sentinel端点。</p>
<pre><code class="language-yaml">management:
  endpoints:
    web:
      exposure:
        include: '*'
</code></pre>
<h3 id="sentinel控制台">Sentinel控制台</h3>
<h4 id="搭建sentinel控制台">搭建Sentinel控制台</h4>
<p>https://github.com/alibaba/Sentinel/releases</p>
<p>生产环境，控制台版本最好和整体版本一致。</p>
<p>启动sentinel控制台</p>
<p><code>java -jar /Users/kim/Downloads/sentinel-dashboard-1.7.2.jar</code></p>
<p>默认在localhost:8080端口，用户名密码都是sentinel。</p>
<p>为内容中心整合sentinel控制台</p>
<pre><code class="language-yaml"># 指定sentinel 控制台地址
spring.cloud.sentinel.transport.dashboard: localhost:8080
</code></pre>
<p>确保nacos、sentinel控制台、内容中心和用户中心都启动了。然后访问http://localhost:8010/shares/1多次，就可以在实时监控里看到效果。</p>
<figure data-type="image" tabindex="39"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200418233034998.png" alt="image-20200418233034998" loading="lazy"></figure>
<h3 id="流控规则">流控规则</h3>
<p>点击簇点链路，点击/shares/1的流控按钮，就可以为这个访问路径设置流控规则。</p>
<figure data-type="image" tabindex="40"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200419110648290.png" alt="image-20200419110648290" loading="lazy"></figure>
<figure data-type="image" tabindex="41"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200419110733958.png" alt="image-20200419110733958" loading="lazy"></figure>
<h4 id="资源名">资源名</h4>
<p>默认是请求路径。</p>
<h4 id="针对来源">针对来源</h4>
<p>针对调用者限流。针对来源是调用者微服务名称。</p>
<h4 id="阈值类型">阈值类型</h4>
<p>QPS、线程数。比如选择QPS，表示：当调用当前资源的QPS达到阈值时，就去限流。</p>
<h4 id="是否集群">是否集群</h4>
<h4 id="流控模式">流控模式</h4>
<h5 id="直接">直接</h5>
<h5 id="关联">关联</h5>
<p><code>&lt;1&gt;</code>当关联的资源达到阈值，就限流自己</p>
<p>比如我们设置关联资源为<code>/actuator/sentinel</code>，当关联资源的qps达到1时，就限流<code>/shares/1</code></p>
<figure data-type="image" tabindex="42"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200419120020951.png" alt="image-20200419120020951" loading="lazy"></figure>
<p>写一个测试类，调用<code>/actuator/sentinel</code></p>
<pre><code class="language-java">public class SentinelTest {
    public static void main(String[] args) throws InterruptedException {
        RestTemplate restTemplate = new RestTemplate();
        for (int i = 0; i &lt; 10000; i++) {
            String forObject = restTemplate.getForObject(&quot;http://localhost:8010/actuator/sentinel&quot;, String.class);
            Thread.sleep(500);
        }
    }
}
</code></pre>
<p>运行这个测试类，再去调用<code>/shares/1</code>,发信啊已经被限流了。</p>
<figure data-type="image" tabindex="43"><img src="https://gitee.com/jinxin.70/oss/raw/master/uPic2/image-20200419121201930.png" alt="image-20200419121201930" loading="lazy"></figure>
<p>实际应用，如果希望修改优先，可以配置关联API为修改的API，资源名设置为查询的API。当修改的测试过多，就限流查询，保证性能。</p>
<h5 id="链路">链路</h5>
<p>只记录指定链路上的流量</p>
<h4 id="流控效果">流控效果</h4>

							</div>
							<div class="wow bounceInDown vt-post-tags">
								
								<a href="https://xinrong2019.github.io/tag/i6gwREvan/" rel="tag">Spring Cloud Alibaba</a>
								
							</div>
							<nav class="navigation3 post-navigation3" role="navigation">

								<div class="nav-links3">
									
									<div class="wow bounceInLeft nav-previous3"><a href="https://xinrong2019.github.io/post/java-ji-chu/"
											rel="prev"> Java基础知识清单</a></div>
									
									
									<div class="wow bounceInRight nav-next3"><a href="https://xinrong2019.github.io/post/wang-ke/"
											rel="next"> 网课分享</a></div>
									
								</div>
							</nav>
							<div class="wow rollIn author-info" style="visibility: visible; animation-name: rollIn;">
								<div class="author-avatar pull-left"><img
										src="https://xinrong2019.github.io//images/avatar.png"></div>
								
								<div class="author-description">
									<div class="author-title">
										<div class="author-link" rel="author">Kim</div>
									</div>
									
									
									<p class="author-bio">Time waits for no one.</p>
								</div>
							</div>
							
						</div>
					</article>
					<div id="marlin_lite_about_widget-2" class="wow bounceInUp widget marlin_lite_about_widget"
						data-wow-delay="0.1s">

						
						
						<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: '2f13af052cedc58f1f20',
    clientSecret: 'ce03139f08944b2398d0f580a3d00ff58958c242',
    repo: 'xinrong2019.github.io',
    owner: 'xinrong2019',
    admin: ['xinrong2019'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

						
						
						
						<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://xinrong2019.github.io//media/scripts/Valine.min.js'></script>

<div class="comment"></div>
<script>
        new Valine({
            // AV 对象来自上面引入av-min.js(老司机们不要开车➳♡゛扎心了老铁)
            av: AV, 
            el: '.comment',
            lang: 'zh-cn',
            
            
     	
      	
          
        });
    </script> 


					</div>
				</div>
				<div class="tocc col l3 hide-on-med-and-down">

    <div class="toc-widget">

        <div class="toc-title"></div>

        <div id="toc-content">


        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.5.0/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '.entry-summary',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('.entry-summary').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });

    $(function () {
        var bt;
        bt = $('.toc-widget');
        if ($(document).width() > 480) {
            $(window).scroll(function () {
                var st;
                st = $(window).scrollTop();
                if (st > 450) {
                    return bt.css('display', 'block');
                } else {
                    return bt.css('display', 'none');
                }
            })
        }
    });
</script>
			</div>
		</div>
		<footer id="colophon" class="site-footer">
	<div class="container">
		<div class="copyright">
			Created by Kim.
			<br>
			<b>Theme: </b>
			<a href="https://github.com/alterfang/gridea-theme-pan" target="_blank" title="Pan">
				<span><b>Pan</b></span>
			</a>
			<b>. Powered by </b>
			<a href="https://gridea.dev/" target="_blank" title="Gridea">
				<span><b>Gridea</b></span>
			</a>
		</div>
	</div><!-- .container -->
</footer><!-- #colophon -->
	</div>

	<script src="https://cdn.bootcss.com/fitvids/1.2.0/jquery.fitvids.min.js"></script>
<script type='text/javascript' src='https://xinrong2019.github.io//media/scripts/marlin-scripts.js'></script>
<script src="//tokinx.github.io/lately/lately.min.js"></script>
<script type='text/javascript' src="https://xinrong2019.github.io//media/scripts/mouse/love.js"></script>

<script src="https://cdn.jsdelivr.net/npm/color-thief-don@2.0.2/src/color-thief.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@1.1.0/dist/Meting.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script>



<script>
  jQuery(document).ready(function () {
    $.lately({
      'target': '.lately-a,.lately-b,.lately-c'
    })
  });
</script>
<style type="text/css">
  /* 一键到顶部 */
  a.back_to_top {
    text-decoration: none;
    position: fixed;
    bottom: 65px;
    right: 30px;
    background: #f0f0f0;
    height: 40px;
    width: 40px;
    border-radius: 50%;
    line-height: 36px;
    font-size: 18px;
    text-align: center;
    transition-duration: .5s;
    transition-propety: background-color;
    display: none;
  }

  a.back_to_top span {
    color: #888;
  }

  a.back_to_top:hover {
    cursor: pointer;
    background: #dfdfdf;
  }

  a.back_to_top:hover span {
    color: #555;
  }

  @media print,
  screen and (max-width: 580px) {
    .back_to_top {
      display: none !important;
    }
  }

  /* 一键到底部 */

  a.down_to_bottom {
    text-decoration: none;
    position: fixed;
    bottom: 15px;
    right: 30px;
    background: #f0f0f0;
    height: 40px;
    width: 40px;
    border-radius: 50%;
    line-height: 36px;
    font-size: 18px;
    text-align: center;
    transition-duration: .5s;
    transition-propety: background-color;
    display: none;
  }

  a.down_to_bottom span {
    color: #888;
  }

  a.down_to_bottom:hover {
    cursor: pointer;
    background: #dfdfdf;
  }

  a.down_to_bottom:hover span {
    color: #555;
  }

  @media print,
  screen and (max-width: 580px) {
    .down_to_bottom {
      display: none !important;
    }
  }
</style>


<a id="back_to_top" href="#" class="back_to_top"><span><i class="iconfont icon-xiangshang"></i></span>
</a>

<a id="down_to_bottom" href="#" class="down_to_bottom"><span><i class="iconfont icon-xiangxia"></i></span>
</a>

<script src="//instant.page/3.0.0" type="module" defer
  integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>

<script>
  function getScrollTop() {
    var scrollTop = 0,
      bodyScrollTop = 0,
      documentScrollTop = 0;
    if (document.body) {
      bodyScrollTop = document.body.scrollTop;
    }
    if (document.documentElement) {
      documentScrollTop = document.documentElement.scrollTop;
    }
    scrollTop = (bodyScrollTop - documentScrollTop > 0) ? bodyScrollTop : documentScrollTop;
    return scrollTop;
  };

  function getScrollHeight() {
    var scrollHeight = 0,
      bodyScrollHeight = 0,
      documentScrollHeight = 0;
    if (document.body) {
      bSH = document.body.scrollHeight;
    }
    if (document.documentElement) {
      dSH = document.documentElement.scrollHeight;
    }
    scrollHeight = (bSH - dSH > 0) ? bSH : dSH;
    return scrollHeight;
  };

  function getWindowHeight() {
    var windowHeight = 0;
    if (document.compatMode == "CSS1Compat") {
      windowHeight = document.documentElement.clientHeight;
    } else {
      windowHeight = document.body.clientHeight;
    }
    return windowHeight;
  };

  $(document).ready((function (_this) {
    return function () {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function () {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block');
          } else {
            return bt.css('display', 'none');
          }
        });
        return bt.click(function () {
          $('body,html').animate({
            scrollTop: 0
          }, 800);
          return false;
        });
      }
    };
  })(this));

  $(document).ready((function (_this) {
    return function () {
      var bt;
      bt = $('#down_to_bottom');
      if ($(document).width() > 480) {
        $(window).scroll(function () {
          var st;
          st = $(window).scrollTop();
          if (getScrollTop() + getWindowHeight() == getScrollHeight()) {
            return bt.css('display', 'none');
          } else {
            return bt.css('display', 'block');
          }
        });
        return bt.click(function () {
          $('body,html').animate({
            scrollTop: $('body,html')[0].scrollHeight
          }, 800);
          return false;
        });
      }
    };
  })(this));
</script>
	<script data-no-instant>
		(function ($) {
			$.extend({
				adamsOverload: function () {
					$('.navigation:eq(0)').remove();
					$("").attr("rel", "external");
					$("a[rel='external'],a[rel='external nofollow']").attr("target", "_blank");
					$("a.vi").attr("rel", "");
					$.viewImage({
						'target': 'img',
						'exclude': '.vsmile-icons img,.gallery img',
						'delay': 300
					});
					$.lately({
						'target': '.commentmetadata a,.infos time,.post-list time'
					});
					prettyPrint();

					$('ul.links li a').each(function () {
						if ($(this).parent().find('.bg').length == 0) {
							$(this).parent().append(
								'<!---<div class="bg" style="background-image:url(https://c3.glgoo.top/s2/favicons?domain=' +
								$(this).attr("href") + ')"></div>--->')
						}
					});
				}
			});
		})(jQuery);
		jQuery.adamsOverload();
	</script>

</body>

</html>